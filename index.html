<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAD/HMV Patient Assessment Tool</title>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 24px;
        }

        .header {
            text-align: center;
            margin-bottom: 24px;
        }

        .title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 16px;
        }

        .progress-container {
            margin-bottom: 24px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background-color: #2563eb;
            transition: width 0.3s ease;
        }

        .question-container {
            margin-bottom: 32px;
        }

        .question-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: flex-start;
        }

        .question-help {
            font-size: 14px;
            color: #6b7280;
            font-style: italic;
            margin-bottom: 16px;
        }

        .options-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .option-button {
            padding: 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
            font-size: 16px;
        }

        .option-button:hover {
            border-color: #3b82f6;
        }

        .option-button.selected-yes {
            border-color: #10b981;
            background-color: #ecfdf5;
        }

        .option-button.selected-no {
            border-color: #ef4444;
            background-color: #fef2f2;
        }

        .option-button.selected-radio {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }

        .number-input-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .number-input {
            flex: 1;
            padding: 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
        }

        .number-input:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .unit-label {
            font-weight: 500;
            color: #6b7280;
        }

        .validation-message {
            padding: 8px;
            border-radius: 4px;
            font-size: 14px;
            margin-top: 8px;
        }

        .validation-success {
            background-color: #ecfdf5;
            color: #065f46;
            border: 1px solid #10b981;
        }

        .validation-error {
            background-color: #fef2f2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-button {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .nav-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background-color: #2563eb;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background-color: #1d4ed8;
        }

        .btn-secondary {
            background-color: transparent;
            color: #6b7280;
        }

        .btn-green {
            background-color: #10b981;
            color: white;
        }

        .btn-green:hover {
            background-color: #059669;
        }

        .pathway-indicator {
            padding: 12px;
            background-color: #eff6ff;
            border: 1px solid #3b82f6;
            border-radius: 6px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #1d4ed8;
        }

        .results-container {
            max-width: 1000px;
        }

        .results-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .view-toggle {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-bottom: 24px;
        }

        .toggle-button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .toggle-active {
            background-color: #2563eb;
            color: white;
        }

        .toggle-inactive {
            background-color: #e5e7eb;
            color: #374151;
        }

        .qualification-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .qualification-card {
            padding: 16px;
            border-radius: 8px;
            border: 2px solid;
        }

        .card-qualified {
            border-color: #10b981;
            background-color: #ecfdf5;
        }

        .card-not-qualified {
            border-color: #ef4444;
            background-color: #fef2f2;
        }

        .card-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 8px;
        }

        .card-title {
            font-size: 14px;
            font-weight: 600;
        }

        .card-status {
            font-size: 14px;
            font-weight: 500;
        }

        .status-qualified {
            color: #065f46;
        }

        .status-not-qualified {
            color: #991b1b;
        }

        .detailed-qualification {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 24px;
        }

        .detailed-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .detailed-title {
            font-size: 18px;
            font-weight: 600;
        }

        .warning-box {
            padding: 12px;
            background-color: #fefce8;
            border: 1px solid #eab308;
            border-radius: 6px;
            margin-bottom: 16px;
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

        .warning-text {
            font-size: 14px;
            color: #92400e;
        }

        .requirements-list {
            margin-bottom: 16px;
        }

        .requirement-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
            font-size: 14px;
        }

        .requirement-met {
            color: #065f46;
        }

        .requirement-not-met {
            color: #991b1b;
        }

        .missing-requirements {
            padding: 12px;
            background-color: #fef2f2;
            border: 1px solid #ef4444;
            border-radius: 6px;
        }

        .missing-title {
            font-size: 14px;
            font-weight: 500;
            color: #991b1b;
            margin-bottom: 4px;
        }

        .missing-list {
            list-style: none;
            padding-left: 0;
        }

        .missing-item {
            font-size: 14px;
            color: #991b1b;
            margin-bottom: 4px;
        }

        .missing-item:before {
            content: "• ";
        }

        .results-actions {
            display: flex;
            justify-content: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .edit-mode-container {
            max-width: 1000px;
        }

        .edit-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .answer-item {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            transition: background-color 0.2s;
        }

        .answer-item:hover {
            background-color: #f9fafb;
        }

        .answer-content {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .answer-question {
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 4px;
        }

        .answer-value {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            border: 1px solid;
        }

        .answer-good {
            color: #065f46;
            background-color: #ecfdf5;
            border-color: #10b981;
        }

        .answer-bad {
            color: #991b1b;
            background-color: #fef2f2;
            border-color: #ef4444;
        }

        .answer-neutral {
            color: #1d4ed8;
            background-color: #eff6ff;
            border-color: #3b82f6;
        }

        .edit-button {
            padding: 4px 12px;
            background-color: #dbeafe;
            color: #1d4ed8;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            margin-left: 12px;
        }

        .edit-button:hover {
            background-color: #bfdbfe;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 640px) {
            .container {
                padding: 16px;
                margin: 10px;
            }
            
            .qualification-grid {
                grid-template-columns: 1fr;
            }
            
            .results-actions {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div id="app-container" class="container">
        <!-- Assessment Questions View -->
        <div id="assessment-view">
            <div class="header">
                <h1 class="title">Patient Assessment Tool</h1>
                <div class="progress-container">
                    <div class="progress-bar">
                        <div id="progress-fill" class="progress-fill" style="width: 0%"></div>
                    </div>
                    <div style="margin-top: 8px; font-size: 14px; color: #6b7280;">
                        Step <span id="current-step">1</span> of <span id="total-steps">8</span>
                    </div>
                </div>
            </div>

            <div id="pathway-indicator" class="pathway-indicator hidden">
                📍
                <span id="pathway-text">Current pathway: </span>
            </div>

            <div class="question-container">
                <div class="question-title">
                    ℹ️
                    <span id="question-text">Loading...</span>
                </div>
                <div id="question-help" class="question-help hidden"></div>
                
                <div id="options-container" class="options-container">
                    <!-- Options will be dynamically inserted here -->
                </div>
            </div>

            <div class="navigation">
                <button id="prev-button" class="nav-button btn-secondary" disabled>
                    ← Previous
                </button>
                <button id="next-button" class="nav-button btn-primary" disabled>
                    <span id="next-text">Next</span> →
                </button>
            </div>
        </div>

        <!-- Results View -->
        <div id="results-view" class="results-container hidden">
            <div class="results-header">
                <h2 class="title">
                    Qualification Results - <span id="results-pathway">Loading...</span>
                </h2>
                <div class="view-toggle">
                    <button id="dashboard-view-btn" class="toggle-button toggle-inactive">Dashboard View</button>
                    <button id="detailed-view-btn" class="toggle-button toggle-active">Detailed View</button>
                </div>
            </div>

            <div id="dashboard-results" class="qualification-grid hidden">
                <!-- Dashboard cards will be inserted here -->
            </div>

            <div id="detailed-results">
                <!-- Detailed results will be inserted here -->
            </div>

            <div class="results-actions">
                <button id="edit-answers-btn" class="nav-button btn-green">Edit Answers</button>
                <button id="restart-btn" class="nav-button btn-primary">Start New Assessment</button>
            </div>
        </div>

        <!-- Edit Mode View -->
        <div id="edit-view" class="edit-mode-container hidden">
            <div class="edit-header">
                <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">Edit Assessment Answers</h3>
                <p style="font-size: 14px; color: #6b7280;">Click any answer to jump to that question and make changes</p>
            </div>

            <div id="edit-answers-list">
                <!-- Edit answers will be inserted here -->
            </div>

            <div class="results-actions" style="padding-top: 16px; border-top: 1px solid #e5e7eb;">
                <button id="back-to-results-btn" class="nav-button btn-secondary" style="background-color: #6b7280; color: white;">Back to Results</button>
                <button id="restart-from-edit-btn" class="nav-button btn-primary">Start New Assessment</button>
            </div>
        </div>
    </div>

    <script>
        // Application State
        let currentStep = 0;
        let answers = {};
        let currentView = 'assessment'; // 'assessment', 'results', 'edit'
        let resultsViewMode = 'detailed'; // 'dashboard', 'detailed'

        // Questions Data
        const universalQuestions = [
            {
                id: 'treatment_purpose',
                question: 'Is this assessment for treatment purposes?',
                type: 'yesno',
                required: true,
                help: 'NCD coverage is specifically for treatment of respiratory conditions'
            },
            {
                id: 'copd_diagnosis',
                question: 'Does the patient have COPD (Chronic Obstructive Pulmonary Disease)?',
                type: 'yesno',
                required: true
            },
            {
                id: 'abg_done',
                question: 'Has the patient had an arterial blood gas (ABG) test?',
                type: 'yesno',
                required: true,
                help: 'Venous blood gas, pulse oximetry, or other methods do not qualify'
            },
            {
                id: 'co2_value',
                question: 'What was the patient\'s CO2 level (PaCO2) on the ABG test?',
                type: 'number',
                required: true,
                help: 'Enter the PaCO2 value in mmHg (must be ≥52 mmHg to qualify)',
                unit: 'mmHg'
            },
            {
                id: 'patient_awake',
                question: 'Was the patient awake during the ABG test?',
                type: 'yesno',
                required: true
            },
            {
                id: 'oxygen_requirement',
                question: 'What is the patient\'s prescribed FiO2?',
                type: 'radio',
                required: true,
                help: 'Prescribed FiO2 may be room air (21%) if patient is not on supplemental oxygen',
                options: [
                    { value: 'room_air', label: 'Room air / 21% (no supplemental oxygen)' },
                    { value: 'low_oxygen', label: 'Low oxygen (<36% or <4L nasal)' },
                    { value: 'high_oxygen', label: 'High oxygen (≥36% or ≥4L nasal)' }
                ]
            },
            {
                id: 'abg_on_prescribed',
                question: 'Was the ABG done while the patient was breathing their prescribed FiO2?',
                type: 'yesno',
                required: true,
                help: 'This includes room air if that is the prescribed FiO2'
            },
            {
                id: 'sleep_apnea_cause',
                question: 'Is sleep apnea the predominant cause of the patient\'s high CO2?',
                type: 'yesno',
                required: true,
                help: 'If sleep apnea is the primary cause, patient may not qualify'
            },
            {
                id: 'current_location',
                question: 'Where is the patient currently?',
                type: 'radio',
                required: true,
                options: [
                    { value: 'hospital', label: 'In hospital (being discharged today)' },
                    { value: 'home', label: 'At home/outpatient setting' }
                ]
            }
        ];

        const hospitalQuestions = [
            {
                id: 'acute_chronic_rf',
                question: 'Does the patient have acute-on-chronic respiratory failure due to COPD?',
                type: 'yesno',
                required: true
            },
            {
                id: 'hospital_device_use',
                question: 'Did the patient require breathing assistance (ventilator, BiPAP, or similar device) during the 24 hours before discharge?',
                type: 'yesno',
                required: true
            },
            {
                id: 'hospital_ventilator_use',
                question: 'Specifically, did the patient require a VENTILATOR (not just BiPAP/RAD) within the 24 hours before discharge?',
                type: 'yesno',
                required: true,
                help: 'This is specifically for HMV qualification - must be actual ventilator use'
            },
            {
                id: 'needs_exceeded_rad',
                question: 'Did the patient\'s needs exceed the capabilities of a RAD (with or without backup rate feature)?',
                type: 'yesno',
                required: true,
                help: 'This is required for hospital discharge HMV qualification'
            },
            {
                id: 'rapid_deterioration_risk',
                question: 'Is the patient at risk of rapid symptom worsening or CO2 rise after discharge?',
                type: 'yesno',
                required: true
            }
        ];

        const homeQuestions = [
            {
                id: 'chronic_rf',
                question: 'Does the patient have chronic respiratory failure (CRF)?',
                type: 'yesno',
                required: true
            },
            {
                id: 'crf_consequent_copd',
                question: 'Is the chronic respiratory failure (CRF) consequent to (caused by) the COPD?',
                type: 'yesno',
                required: true,
                help: 'The CRF must be directly caused by the COPD for coverage'
            },
            {
                id: 'stability_status',
                question: 'Which describes the patient\'s condition?',
                type: 'radio',
                required: true,
                options: [
                    { 
                        value: 'stable', 
                        label: 'Stable COPD (no increase in or new onset of MORE THAN ONE respiratory symptom - cough, sputum production, sputum purulence, wheezing, or dyspnea - lasting 2+ days AND no change of pharmacological treatment during 2-week period before NIV initiation)' 
                    },
                    { 
                        value: 'post_hospital', 
                        label: 'Post-hospital recovery (hypercapnia present for at least 2 weeks post hospitalization after resolution of COPD exacerbation requiring acute NIV)' 
                    },
                    { 
                        value: 'unstable', 
                        label: 'Does not meet either stability condition above' 
                    }
                ]
            }
        ];

        const deviceQuestions = [
            {
                id: 'ventilation_hours',
                question: 'Does the patient need breathing support for more than 8 hours per day?',
                type: 'yesno',
                required: true
            },
            {
                id: 'safety_requirements',
                question: 'Does the patient need alarms and backup battery because stopping breathing support for a few hours could be life-threatening?',
                type: 'yesno',
                required: true,
                help: 'This is for patients who cannot breathe effectively on their own for more than a few hours'
            },
            {
                id: 'current_high_intensity',
                question: 'Is the patient currently using high-intensity settings (≥15 cm H2O pressure AND ≥14 breaths/minute backup rate)?',
                type: 'yesno',
                required: true
            },
            {
                id: 'can_tolerate_high_intensity',
                question: 'Can the patient tolerate high-intensity therapy if not currently using it?',
                type: 'yesno',
                required: true,
                help: 'High-intensity = ≥15 cm H2O pressure with ≥14 breaths/minute backup rate'
            },
            {
                id: 'backup_rate_inappropriate',
                question: 'Is the backup rate feature medically inappropriate for this patient?',
                type: 'yesno',
                required: true,
                help: 'Medical contraindications separate from tolerance (e.g., anxiety, claustrophobia, cardiac conditions)'
            },
            {
                id: 'rad_clinical_outcomes',
                question: 'Will a RAD device likely FAIL to help this patient achieve clinical improvement?',
                type: 'yesno',
                required: true,
                help: 'Answer YES if the patient is too sick for a RAD to work effectively (needs exceed RAD capabilities). Answer NO if a RAD would likely help normalize CO2, stabilize CO2, reduce CO2 by 20%, or improve symptoms like headache, fatigue, shortness of breath, confusion, or sleep quality.'
            },
            {
                id: 'hmv_volume_mode',
                question: 'Is a volume-targeted mode (or SuperCare Health "set to protocol") being prescribed?',
                type: 'yesno',
                required: true,
                help: 'HMV coverage requires volume-targeted mode prescription'
            }
        ];

        // Helper Functions
        function getQuestionFlow() {
            let flow = [...universalQuestions];
            
            if (answers.current_location === 'hospital') {
                flow = [...flow, ...hospitalQuestions, ...deviceQuestions];
            } else if (answers.current_location === 'home') {
                flow = [...flow, ...homeQuestions, ...deviceQuestions];
            } else {
                return universalQuestions;
            }
            
            return flow;
        }

        function getQuestionById(id) {
            const allQuestions = [...universalQuestions, ...hospitalQuestions, ...homeQuestions, ...deviceQuestions];
            return allQuestions.find(q => q.id === id);
        }

        function getAnswerStatus(questionId, value) {
            const goodAnswers = ['treatment_purpose', 'copd_diagnosis', 'abg_done', 'patient_awake', 'abg_on_prescribed', 'chronic_rf', 'crf_consequent_copd', 'acute_chronic_rf', 'hospital_device_use', 'hospital_ventilator_use', 'needs_exceeded_rad', 'rapid_deterioration_risk', 'ventilation_hours', 'safety_requirements', 'current_high_intensity', 'can_tolerate_high_intensity', 'rad_clinical_outcomes', 'hmv_volume_mode'];
            const badAnswers = ['sleep_apnea_cause', 'backup_rate_inappropriate'];
            
            if (goodAnswers.includes(questionId)) {
                return value === 'yes' ? 'good' : 'bad';
            } else if (badAnswers.includes(questionId)) {
                return value === 'no' ? 'good' : 'bad';
            } else if (questionId === 'co2_value') {
                return parseFloat(value) >= 52 ? 'good' : 'bad';
            } else if (questionId === 'stability_status') {
                return ['stable', 'post_hospital'].includes(value) ? 'good' : 'bad';
            } else {
                return 'neutral';
            }
        }

        function getAnswerDisplay(questionId, value) {
            const question = getQuestionById(questionId);
            if (!question) return value;
            
            if (question.type === 'yesno') {
                return value === 'yes' ? '✓ Yes' : '✗ No';
            } else if (question.type === 'radio') {
                const option = question.options?.find(opt => opt.value === value);
                return option ? option.label : value;
            } else if (question.type === 'number' && question.unit) {
                return `${value} ${question.unit}`;
            }
            return value;
        }

        function calculateAllQualifications() {
            const location = answers.current_location;
            const currentlyUsingHighIntensity = answers.current_high_intensity === 'yes';
            const canTolerateHighIntensity = answers.can_tolerate_high_intensity === 'yes';
            const backupRateInappropriate = answers.backup_rate_inappropriate === 'yes';
            
            const highIntensityQualified = currentlyUsingHighIntensity || canTolerateHighIntensity;
            const needsWarning = !currentlyUsingHighIntensity && canTolerateHighIntensity;

            const baseRequirements = [
                { key: 'treatment_purpose', label: 'Assessment for treatment purposes', met: answers.treatment_purpose === 'yes' },
                { key: 'copd_diagnosis', label: 'COPD diagnosis', met: answers.copd_diagnosis === 'yes' },
                { key: 'abg_done', label: 'ABG test completed', met: answers.abg_done === 'yes' },
                { key: 'co2_value', label: 'High CO2 (≥52 mmHg)', met: parseFloat(answers.co2_value) >= 52 },
                { key: 'patient_awake', label: 'Patient awake during ABG', met: answers.patient_awake === 'yes' },
                { key: 'abg_on_prescribed', label: 'ABG done on prescribed FiO2', met: answers.abg_on_prescribed === 'yes' },
                { key: 'sleep_apnea_cause', label: 'Sleep apnea not primary cause', met: answers.sleep_apnea_cause === 'no' }
            ];

            let qualifications = {};

            if (location === 'home') {
                const homeBaseRequirements = [
                    ...baseRequirements,
                    { key: 'chronic_rf', label: 'Chronic respiratory failure (CRF)', met: answers.chronic_rf === 'yes' },
                    { key: 'crf_consequent_copd', label: 'CRF consequent to COPD', met: answers.crf_consequent_copd === 'yes' }
                ];

                qualifications['RAD with Backup Rate (Home)'] = {
                    qualified: false,
                    missing: [],
                    warning: null,
                    requirements: [
                        ...homeBaseRequirements,
                        { key: 'stability_status', label: 'Stable condition or post-hospital recovery', met: ['stable', 'post_hospital'].includes(answers.stability_status) },
                        { key: 'high_intensity', label: 'Can use high-intensity therapy', met: highIntensityQualified },
                        { key: 'backup_appropriate', label: 'Backup rate feature medically appropriate', met: !backupRateInappropriate }
                    ]
                };

                qualifications['RAD without Backup Rate (Home)'] = {
                    qualified: false,
                    missing: [],
                    warning: null,
                    requirements: [
                        ...homeBaseRequirements,
                        { key: 'high_intensity_intolerance', label: 'Cannot tolerate high-intensity NIV OR backup rate feature medically inappropriate', met: !highIntensityQualified || backupRateInappropriate }
                    ]
                };

                qualifications['Home Mechanical Ventilator (Home)'] = {
                    qualified: false,
                    missing: [],
                    warning: null,
                    notice: '📋 NOTICE: Prescription for volume-targeted mode or SuperCare Health "set to protocol" required',
                    requirements: [
                        ...homeBaseRequirements,
                        { key: 'hmv_volume_mode', label: 'Volume-targeted mode prescribed', met: answers.hmv_volume_mode === 'yes' },
                        { key: 'hmv_criteria', label: 'At least one HMV criteria met', met: 
                            answers.oxygen_requirement === 'high_oxygen' || 
                            answers.ventilation_hours === 'yes' || 
                            answers.safety_requirements === 'yes' || 
                            answers.rad_clinical_outcomes === 'yes' 
                        }
                    ]
                };

            } else if (location === 'hospital') {
                const hospitalBaseRequirements = [
                    ...baseRequirements,
                    { key: 'acute_chronic_rf', label: 'Acute-on-chronic respiratory failure due to COPD', met: answers.acute_chronic_rf === 'yes' },
                    { key: 'hospital_device_use', label: 'Used ventilator/RAD in last 24 hours', met: answers.hospital_device_use === 'yes' },
                    { key: 'rapid_deterioration_risk', label: 'At risk of rapid deterioration', met: answers.rapid_deterioration_risk === 'yes' }
                ];

                qualifications['RAD with Backup Rate (Hospital Discharge)'] = {
                    qualified: false,
                    missing: [],
                    warning: null,
                    requirements: [
                        ...hospitalBaseRequirements,
                        { key: 'high_intensity', label: 'Can use high-intensity therapy', met: highIntensityQualified },
                        { key: 'backup_appropriate', label: 'Backup rate feature medically appropriate', met: !backupRateInappropriate }
                    ]
                };

                qualifications['RAD without Backup Rate (Hospital Discharge)'] = {
                    qualified: false,
                    missing: [],
                    warning: null,
                    requirements: [
                        ...hospitalBaseRequirements,
                        { key: 'high_intensity_intolerance', label: 'Cannot tolerate high-intensity NIV OR backup rate feature medically inappropriate', met: !highIntensityQualified || backupRateInappropriate }
                    ]
                };

                qualifications['Home Mechanical Ventilator (Hospital Discharge)'] = {
                    qualified: false,
                    missing: [],
                    warning: null,
                    notice: '📋 NOTICE: Prescription for volume-targeted mode or SuperCare Health "set to protocol" required',
                    requirements: [
                        ...hospitalBaseRequirements,
                        { key: 'hospital_ventilator_use', label: 'Required ventilator in last 24 hours', met: answers.hospital_ventilator_use === 'yes' },
                        { key: 'needs_exceeded_rad', label: 'Patient needs exceeded RAD capabilities', met: answers.needs_exceeded_rad === 'yes' },
                        { key: 'hmv_volume_mode', label: 'Volume-targeted mode prescribed', met: answers.hmv_volume_mode === 'yes' },
                        { key: 'hmv_criteria', label: 'At least one HMV criteria met', met: 
                            answers.oxygen_requirement === 'high_oxygen' || 
                            answers.ventilation_hours === 'yes' || 
                            answers.safety_requirements === 'yes' || 
                            answers.rad_clinical_outcomes === 'yes' 
                        }
                    ]
                };
            }

            // Calculate qualification status and add warnings
            Object.keys(qualifications).forEach(key => {
                const qual = qualifications[key];
                const metRequirements = qual.requirements.filter(req => req.met);
                const unmetRequirements = qual.requirements.filter(req => !req.met);
                
                qual.qualified = unmetRequirements.length === 0;
                qual.missing = unmetRequirements.map(req => req.label);
                qual.metCount = metRequirements.length;
                qual.totalCount = qual.requirements.length;

                if (key.includes('RAD with Backup Rate') && qual.qualified && needsWarning) {
                    qual.warning = '⚠️ WARNING: Patient qualifies but is not currently on required settings. Patient MUST achieve ≥15 cm H2O pressure AND ≥14 breaths/minute backup rate by month 6, or device will be at risk for Medicare pickup.';
                }
            });

            return qualifications;
        }

        // UI Functions
        function updateProgress() {
            const questionFlow = getQuestionFlow();
            const progress = ((currentStep + 1) / questionFlow.length) * 100;
            document.getElementById('progress-fill').style.width = `${progress}%`;
            document.getElementById('current-step').textContent = currentStep + 1;
            document.getElementById('total-steps').textContent = questionFlow.length;
        }

        function updatePathwayIndicator() {
            const indicator = document.getElementById('pathway-indicator');
            const text = document.getElementById('pathway-text');
            
            if (answers.current_location) {
                const pathwayName = answers.current_location === 'hospital' ? 'Hospital Discharge' : 'Home/Outpatient';
                text.textContent = `Current pathway: ${pathwayName}`;
                indicator.classList.remove('hidden');
            } else {
                indicator.classList.add('hidden');
            }
        }

        function renderQuestion() {
            const questionFlow = getQuestionFlow();
            const question = questionFlow[currentStep];
            
            if (!question) return;

            document.getElementById('question-text').textContent = question.question;
            
            const helpElement = document.getElementById('question-help');
            if (question.help) {
                helpElement.textContent = question.help;
                helpElement.classList.remove('hidden');
            } else {
                helpElement.classList.add('hidden');
            }

            const container = document.getElementById('options-container');
            container.innerHTML = '';

            if (question.type === 'yesno') {
                const yesButton = document.createElement('button');
                yesButton.className = `option-button ${answers[question.id] === 'yes' ? 'selected-yes' : ''}`;
                yesButton.innerHTML = '✓ Yes';
                yesButton.onclick = () => handleAnswer(question.id, 'yes');

                const noButton = document.createElement('button');
                noButton.className = `option-button ${answers[question.id] === 'no' ? 'selected-no' : ''}`;
                noButton.innerHTML = '✗ No';
                noButton.onclick = () => handleAnswer(question.id, 'no');

                container.appendChild(yesButton);
                container.appendChild(noButton);

            } else if (question.type === 'number') {
                const inputContainer = document.createElement('div');
                inputContainer.className = 'number-input-container';

                const input = document.createElement('input');
                input.type = 'number';
                input.className = 'number-input';
                input.placeholder = 'Enter CO2 value';
                input.value = answers[question.id] || '';
                input.oninput = (e) => handleAnswer(question.id, e.target.value);

                const unitLabel = document.createElement('span');
                unitLabel.className = 'unit-label';
                unitLabel.textContent = question.unit || '';

                inputContainer.appendChild(input);
                if (question.unit) inputContainer.appendChild(unitLabel);
                container.appendChild(inputContainer);

                if (answers[question.id]) {
                    const validation = document.createElement('div');
                    const value = parseFloat(answers[question.id]);
                    const isValid = value >= 52;
                    validation.className = `validation-message ${isValid ? 'validation-success' : 'validation-error'}`;
                    validation.textContent = isValid ? '✓ Meets requirement (≥52 mmHg)' : '✗ Does not meet requirement (≥52 mmHg)';
                    container.appendChild(validation);
                }

            } else if (question.type === 'radio') {
                question.options.forEach(option => {
                    const button = document.createElement('button');
                    button.className = `option-button ${answers[question.id] === option.value ? 'selected-radio' : ''}`;
                    button.textContent = option.label;
                    button.onclick = () => handleAnswer(question.id, option.value);
                    container.appendChild(button);
                });
            }

            updateNavigationButtons();
            updateProgress();
            updatePathwayIndicator();
        }

        function updateNavigationButtons() {
            const prevButton = document.getElementById('prev-button');
            const nextButton = document.getElementById('next-button');
            const nextText = document.getElementById('next-text');
            const questionFlow = getQuestionFlow();
            const currentQuestion = questionFlow[currentStep];

            prevButton.disabled = currentStep === 0;
            nextButton.disabled = !answers[currentQuestion?.id];
            
            if (currentStep === questionFlow.length - 1) {
                nextText.textContent = 'Get Results';
            } else {
                nextText.textContent = 'Next';
            }
        }

        function handleAnswer(questionId, value) {
            answers[questionId] = value;
            renderQuestion();
        }

        function nextStep() {
            const questionFlow = getQuestionFlow();
            if (currentStep < questionFlow.length - 1) {
                currentStep++;
                renderQuestion();
            } else {
                showResults();
            }
        }

        function prevStep() {
            if (currentStep > 0) {
                currentStep--;
                renderQuestion();
            }
        }

        function showResults() {
            const qualifications = calculateAllQualifications();
            currentView = 'results';
            
            document.getElementById('assessment-view').classList.add('hidden');
            document.getElementById('results-view').classList.remove('hidden');
            document.getElementById('edit-view').classList.add('hidden');
            
            const pathwayName = answers.current_location === 'hospital' ? 'Hospital Discharge' : 'Home/Outpatient';
            document.getElementById('results-pathway').textContent = pathwayName;
            
            renderResults(qualifications);
        }

        function renderResults(qualifications) {
            if (resultsViewMode === 'dashboard') {
                renderDashboard(qualifications);
            } else {
                renderDetailed(qualifications);
            }
        }

        function renderDashboard(qualifications) {
            const container = document.getElementById('dashboard-results');
            container.innerHTML = '';
            container.classList.remove('hidden');
            document.getElementById('detailed-results').classList.add('hidden');

            Object.entries(qualifications).forEach(([name, qual]) => {
                const card = document.createElement('div');
                card.className = `qualification-card ${qual.qualified ? 'card-qualified' : 'card-not-qualified'}`;
                
                card.innerHTML = `
                    <div class="card-header">
                        <div class="card-title">${name}</div>
                        <div style="display: flex; align-items: center; gap: 4px;">
                            ${qual.warning ? '<span style="color: #eab308;">⚠️</span>' : ''}
                            <span style="color: ${qual.qualified ? '#10b981' : '#ef4444'};">${qual.qualified ? '✅' : '❌'}</span>
                        </div>
                    </div>
                    <div style="font-size: 12px; color: #6b7280; margin-bottom: 8px;">
                        ${qual.metCount}/${qual.totalCount} requirements met
                    </div>
                    <div class="card-status ${qual.qualified ? 'status-qualified' : 'status-not-qualified'}">
                        ${qual.qualified ? 'QUALIFIED' : 'NOT QUALIFIED'}
                    </div>
                    ${!qual.qualified && qual.missing.length > 0 ? `
                        <div style="margin-top: 8px; font-size: 12px; color: #991b1b;">
                            Missing: ${qual.missing.slice(0, 2).join(', ')}${qual.missing.length > 2 ? '...' : ''}
                        </div>
                    ` : ''}
                `;
                
                container.appendChild(card);
            });
        }

        function renderDetailed(qualifications) {
            const container = document.getElementById('detailed-results');
            container.innerHTML = '';
            container.classList.remove('hidden');
            document.getElementById('dashboard-results').classList.add('hidden');

            Object.entries(qualifications).forEach(([name, qual]) => {
                const section = document.createElement('div');
                section.className = 'detailed-qualification';
                
                let warningHtml = '';
                if (qual.warning) {
                    warningHtml = `
                        <div class="warning-box">
                            <span style="color: #eab308; flex-shrink: 0; margin-top: 2px;">⚠️</span>
                            <div class="warning-text">${qual.warning}</div>
                        </div>
                    `;
                }

                let noticeHtml = '';
                if (qual.notice) {
                    noticeHtml = `
                        <div style="padding: 12px; background-color: #eff6ff; border: 1px solid #3b82f6; border-radius: 6px; margin-bottom: 16px; display: flex; align-items: flex-start; gap: 8px;">
                            <span style="color: #1d4ed8; flex-shrink: 0; margin-top: 2px;">📋</span>
                            <div style="font-size: 14px; color: #1d4ed8;">${qual.notice}</div>
                        </div>
                    `;
                }

                let requirementsHtml = qual.requirements.map(req => `
                    <div class="requirement-item ${req.met ? 'requirement-met' : 'requirement-not-met'}">
                        <span style="color: ${req.met ? '#10b981' : '#ef4444'};">${req.met ? '✅' : '❌'}</span>
                        <span>${req.label}</span>
                    </div>
                `).join('');

                let missingHtml = '';
                if (!qual.qualified) {
                    missingHtml = `
                        <div class="missing-requirements">
                            <div class="missing-title">Missing Requirements:</div>
                            <ul class="missing-list">
                                ${qual.missing.map(missing => `<li class="missing-item">${missing}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }

                section.innerHTML = `
                    <div class="detailed-header">
                        <div class="detailed-title">${name}</div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            ${qual.warning ? '<span style="color: #eab308; font-size: 20px;">⚠️</span>' : ''}
                            <span style="color: ${qual.qualified ? '#10b981' : '#ef4444'}; font-size: 20px;">${qual.qualified ? '✅' : '❌'}</span>
                            <span class="${qual.qualified ? 'requirement-met' : 'requirement-not-met'}" style="font-weight: 500;">
                                ${qual.qualified ? 'QUALIFIED' : 'NOT QUALIFIED'}
                            </span>
                        </div>
                    </div>
                    ${warningHtml}
                    ${noticeHtml}
                    <div class="requirements-list">
                        <div style="font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 8px;">Requirements:</div>
                        ${requirementsHtml}
                    </div>
                    ${missingHtml}
                `;
                
                container.appendChild(section);
            });
        }

        function showEditMode() {
            currentView = 'edit';
            
            document.getElementById('assessment-view').classList.add('hidden');
            document.getElementById('results-view').classList.add('hidden');
            document.getElementById('edit-view').classList.remove('hidden');
            
            renderEditMode();
        }

        function renderEditMode() {
            const container = document.getElementById('edit-answers-list');
            container.innerHTML = '';
            const questionFlow = getQuestionFlow();

            questionFlow.forEach((question, index) => {
                const answer = answers[question.id];
                if (!answer) return;

                const answerStatus = getAnswerStatus(question.id, answer);
                const statusClass = `answer-${answerStatus}`;

                const item = document.createElement('div');
                item.className = 'answer-item';
                
                item.innerHTML = `
                    <div class="answer-content">
                        <div style="flex: 1;">
                            <div class="answer-question">${index + 1}. ${question.question}</div>
                            <div class="answer-value ${statusClass}">
                                ${getAnswerDisplay(question.id, answer)}
                            </div>
                        </div>
                        <button class="edit-button" onclick="jumpToQuestion('${question.id}')">Edit</button>
                    </div>
                `;
                
                container.appendChild(item);
            });
        }

        function jumpToQuestion(questionId) {
            const questionFlow = getQuestionFlow();
            const questionIndex = questionFlow.findIndex(q => q.id === questionId);
            if (questionIndex !== -1) {
                currentStep = questionIndex;
                currentView = 'assessment';
                
                document.getElementById('assessment-view').classList.remove('hidden');
                document.getElementById('results-view').classList.add('hidden');
                document.getElementById('edit-view').classList.add('hidden');
                
                renderQuestion();
            }
        }

        function restart() {
            currentStep = 0;
            answers = {};
            currentView = 'assessment';
            
            document.getElementById('assessment-view').classList.remove('hidden');
            document.getElementById('results-view').classList.add('hidden');
            document.getElementById('edit-view').classList.add('hidden');
            
            renderQuestion();
        }

        // Event Listeners
        document.getElementById('prev-button').addEventListener('click', prevStep);
        document.getElementById('next-button').addEventListener('click', nextStep);
        document.getElementById('edit-answers-btn').addEventListener('click', showEditMode);
        document.getElementById('restart-btn').addEventListener('click', restart);
        document.getElementById('back-to-results-btn').addEventListener('click', () => {
            currentView = 'results';
            document.getElementById('assessment-view').classList.add('hidden');
            document.getElementById('results-view').classList.remove('hidden');
            document.getElementById('edit-view').classList.add('hidden');
        });
        document.getElementById('restart-from-edit-btn').addEventListener('click', restart);

        document.getElementById('dashboard-view-btn').addEventListener('click', () => {
            resultsViewMode = 'dashboard';
            document.getElementById('dashboard-view-btn').className = 'toggle-button toggle-active';
            document.getElementById('detailed-view-btn').className = 'toggle-button toggle-inactive';
            if (currentView === 'results') {
                renderResults(calculateAllQualifications());
            }
        });

        document.getElementById('detailed-view-btn').addEventListener('click', () => {
            resultsViewMode = 'detailed';
            document.getElementById('detailed-view-btn').className = 'toggle-button toggle-active';
            document.getElementById('dashboard-view-btn').className = 'toggle-button toggle-inactive';
            if (currentView === 'results') {
                renderResults(calculateAllQualifications());
            }
        });

        // Initialize
        renderQuestion();
    </script>
</body>
</html>